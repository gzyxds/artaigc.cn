---
/**
 * 商店页面 - 艺创AI产品展示 (重构版)
 */

import Layout from '../layouts/Layout.astro';
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
import Contact from '../components/sections/Contact.astro';
import Calltoaction from '../components/sections/Calltoaction.astro';
import { products as rawProducts, getCategory, type Product } from '../data/products';
import { Icon } from 'astro-icon/components';
import { Image } from 'astro:assets';
import { getProductImage } from '../data/images';

// 产品数据(: Product)
const products = rawProducts.map(p => ({
  ...p,
  name: p.title,
  category: p.category || getCategory(p.subtitle),
  imageSrc: getProductImage(p.image)
}));

const categories = [
  { id: 'all', name: '全部应用', icon: 'lucide:zap' },
  { id: 'independent', name: '独立系统', icon: 'lucide:database' },
];

const pluginCategories = [
  { id: 'video', name: '图像视频', icon: 'lucide:video' },
  { id: 'writing', name: '智能写作', icon: 'lucide:pen-tool' },
  { id: 'enterprise', name: '企业工具', icon: 'lucide:briefcase' },
  { id: 'efficiency', name: '效率工具', icon: 'lucide:layout-grid' },
];

// 定义样式常量
const shopBtnActiveClass = "bg-blue-600 text-white font-semibold rounded-none ring-0";
const shopBtnInactiveClass = "bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 hover:border-blue-300 dark:hover:border-blue-700 hover:text-blue-600 dark:hover:text-blue-300 rounded-none";
const shopIconActiveClass = "text-white";
const shopIconInactiveClass = "text-gray-400 dark:text-gray-300 group-hover:text-blue-500 transition-colors";
const shopActiveBgClass = "absolute inset-0 bg-transparent rounded-none pointer-events-none"; // 移除渐变背景
---

<Layout
  title="艺创AI产品中心_AI系统源码_数字人系统_知识库系统"
  description="艺创AI产品中心，提供AI数字人系统、知识库系统、聊天绘画系统、论文写作系统等全方位AI解决方案源码，支持私有化部署。"
  keywords="AI系统源码,AI数字人,知识库系统,聊天绘画,论文写作,PHP AI源码,Java AI源码"
>
  <Header />

  <!-- 主体内容区域 -->
  <div
    class="min-h-screen bg-background pt-8 pb-20 relative typography-system"
    x-data={`{
      searchQuery: '',
      activeCategory: 'all',
      visibleCount: ${products.length},

      updateVisibility() {
        const query = this.searchQuery.toLowerCase().trim();
        const items = document.querySelectorAll('.product-item');
        let count = 0;

        items.forEach(el => {
          const name = (el.dataset.name || '').toLowerCase();
          const desc = (el.dataset.desc || '').toLowerCase();
          const sub = (el.dataset.subtitle || '').toLowerCase();
          const features = (el.dataset.features || '').toLowerCase();
          const category = el.dataset.category;

          // 搜索匹配
          const matchSearch = query === '' ||
            name.includes(query) ||
            desc.includes(query) ||
            sub.includes(query) ||
            features.includes(query);

          // 分类匹配逻辑
          let matchCategory = false;
          if (this.activeCategory === 'all') {
            matchCategory = true;
          } else if (this.activeCategory === 'independent') {
             // 独立系统匹配规则：包含特定关键词
             matchCategory = /独立系统|源码版/.test(name) || /独立系统|源码版/.test(sub);
          } else if (this.activeCategory === category) {
             matchCategory = true;
          } else {
             // 备用：基于 subtitle 的模糊匹配 (复刻 React 逻辑)
             if (this.activeCategory === 'video' && /图像视频|聊天绘画|数字人/.test(sub)) matchCategory = true;
             if (this.activeCategory === 'writing' && /智能写作|知识库|论文/.test(sub)) matchCategory = true;
             if (this.activeCategory === 'enterprise' && /企业工具|知识库/.test(sub)) matchCategory = true;
             if (this.activeCategory === 'efficiency' && /效率工具/.test(sub)) matchCategory = true;
          }

          if (matchSearch && matchCategory) {
            el.style.display = ''; // Reset display
            count++;
          } else {
            el.style.display = 'none';
          }
        });

        this.visibleCount = count;
      }
    }`}
    x-init="updateVisibility(); $watch('searchQuery', () => updateVisibility()); $watch('activeCategory', () => updateVisibility())"
  >
    <!-- 背景装饰 (使用网格背景代替模糊球) -->
    <div class="absolute inset-0 bg-[url('/grid-pattern.svg')] opacity-[0.03] pointer-events-none"></div>

    <div class="container-custom relative z-10">
      <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">

        <!-- 左侧边栏 -->
        <aside class="w-full lg:w-72 shrink-0 space-y-8">
          <div class="sticky top-24 space-y-8">
            <!-- 搜索框 -->
            <div class="relative group">
              <!-- 移除装饰性背景 -->
              <div class="relative bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 transition-all duration-300 group-focus-within:border-blue-500 rounded-none">
                <input
                  type="text"
                  placeholder="搜索应用..."
                  x-model="searchQuery"
                  class="w-full pl-11 pr-4 py-3.5 bg-transparent outline-none text-sm text-gray-900 dark:text-gray-100 placeholder:text-gray-400 rounded-none"
                />
                <div class="absolute left-3.5 top-3.5 text-gray-400 group-focus-within:text-blue-500 transition-colors">
                  <Icon name="lucide:search" class="w-5 h-5" />
                </div>
              </div>
            </div>

            <!-- 分类导航 -->
            <div class="space-y-3">
              <h3 class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">分类导航</h3>
              <nav class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 -mx-4 px-4 lg:mx-0 lg:px-0 scrollbar-hide">
                {categories.map((cat) => (
                  <button
                    @click={`activeCategory = '${cat.id}'`}
                    class="relative shrink-0 w-auto lg:w-full text-left px-4 py-3 rounded-none text-sm transition-all duration-200 group overflow-hidden border focus:outline-none"
                    :class={`activeCategory === '${cat.id}' ? shopBtnActiveClass : shopBtnInactiveClass`}
                    :aria-pressed={`activeCategory === '${cat.id}'`}
                    :aria-selected={`activeCategory === '${cat.id}'`}
                    role="button"
                  >
                    <!-- 移除渐变背景 div -->

                    <!-- 选中状态的左侧指示条 -->
                    <span
                      x-show={`activeCategory === '${cat.id}'`}
                      class="absolute left-0 top-0 bottom-0 w-1 bg-white"
                      x-transition:enter="transition ease-out duration-200"
                      x-transition:enter-start="-translate-x-full opacity-0"
                      x-transition:enter-end="translate-x-0 opacity-100"
                    ></span>

                    <span class="relative z-10 flex items-center gap-3">
                      <Icon name={cat.icon} class="w-4 h-4" :class={`activeCategory === '${cat.id}' ? shopIconActiveClass : shopIconInactiveClass`} />
                      <span :class={`activeCategory === '${cat.id}' ? 'font-bold' : 'font-medium'`}>{cat.name}</span>
                      <Icon name="lucide:badge-check" x-show={`activeCategory === '${cat.id}'`} class="w-3.5 h-3.5 text-white ml-auto" />
                    </span>
                  </button>
                ))}
              </nav>
            </div>

            <!-- 插件应用 -->
            <div class="space-y-3 pt-2">
              <h3 class="px-2 text-xs font-semibold text-gray-400 uppercase tracking-wider">插件应用</h3>
              <nav class="flex lg:flex-col gap-2 overflow-x-auto lg:overflow-visible pb-2 lg:pb-0 -mx-4 px-4 lg:mx-0 lg:px-0 scrollbar-hide">
                {pluginCategories.map((cat) => (
                  <button
                    @click={`activeCategory = '${cat.id}'`}
                    class="relative shrink-0 w-auto lg:w-full text-left px-4 py-3 rounded-none text-sm transition-all duration-200 group overflow-hidden border focus:outline-none"
                    :class={`activeCategory === '${cat.id}' ? shopBtnActiveClass : shopBtnInactiveClass`}
                    :aria-pressed={`activeCategory === '${cat.id}'`}
                    :aria-selected={`activeCategory === '${cat.id}'`}
                    role="button"
                  >
                    <!-- 移除渐变背景 div -->

                    <span
                      x-show={`activeCategory === '${cat.id}'`}
                      class="absolute left-0 top-0 bottom-0 w-1 bg-white"
                      x-transition:enter="transition ease-out duration-200"
                      x-transition:enter-start="-translate-x-full opacity-0"
                      x-transition:enter-end="translate-x-0 opacity-100"
                    ></span>

                    <span class="relative z-10 flex items-center gap-3">
                      <Icon name={cat.icon} class="w-4 h-4" :class={`activeCategory === '${cat.id}' ? shopIconActiveClass : shopIconInactiveClass`} />
                      <span :class={`activeCategory === '${cat.id}' ? 'font-bold' : 'font-medium'`}>{cat.name}</span>
                      <Icon name="lucide:badge-check" x-show={`activeCategory === '${cat.id}'`} class="w-3.5 h-3.5 text-white ml-auto" />
                    </span>
                  </button>
                ))}
              </nav>
            </div>
          </div>
        </aside>

        <!-- 右侧主内容 -->
        <main class="flex-1 min-w-0">
          <!-- 促销 Banner - 简化风格 -->
          <div class="relative bento-card p-6 md:p-8 mb-8 border-blue-200 dark:border-blue-900">
             <!-- 装饰角标 -->
             <div class="corner-marker top-0 right-0 border-t border-r rounded-bl-none"></div>
             <div class="corner-marker bottom-0 left-0 border-b border-l rounded-tr-none"></div>

            <div class="relative z-10 flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
              <div class="space-y-1 max-w-lg">
                <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400 text-xs font-medium bg-blue-50 dark:bg-blue-900/20 px-2.5 py-0.5 border border-blue-100 dark:border-blue-800 w-fit mb-2">
                  <Icon name="lucide:sparkles" class="w-3 h-3" />
                  <span>限时特惠活动</span>
                </div>
                <h2 class="type-display font-bold tracking-tight text-gray-900 dark:text-white">
                  解锁 AI 生产力工具
                </h2>
                <p class="type-body text-gray-500 dark:text-gray-400 leading-relaxed">
                  联系客服领取限时 <span class="text-blue-600 dark:text-blue-400 font-bold">5折优惠码</span>，
                  助力您的业务快速腾飞。
                </p>
              </div>
              <a
                href="/contact"
                class="inline-flex items-center justify-center bg-blue-600 hover:bg-blue-700 text-white transition-colors duration-200 rounded-none font-semibold px-6 h-10 text-sm border border-blue-600 hover:border-blue-700"
              >
                获取优惠码
                <Icon name="lucide:arrow-right" class="w-3.5 h-3.5 ml-1.5" />
              </a>
            </div>
          </div>

          <!-- 应用列表头 -->
          <div class="flex items-center justify-between mb-6">
            <h2 class="type-heading font-semibold text-gray-900 dark:text-white flex items-center gap-2">
              <span class="w-1.5 h-6 bg-blue-500"></span>
              全部应用
              <span class="type-small font-normal text-gray-500 ml-2" x-text="`(${visibleCount})`"></span>
            </h2>
          </div>

          <!-- 应用卡片网格 -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            {products.map((app) => (
              <div
                class="product-item group h-full"
                data-name={app.name}
                data-desc={app.description}
                data-subtitle={app.subtitle}
                data-category={app.category}
                data-features={app.features.join(',')}
              >
                <div class="bento-card flex flex-col h-full p-0 overflow-hidden hover:border-blue-500 dark:hover:border-blue-500">
                  <!-- Hover 装饰角标 -->
                  <div class="corner-marker top-0 right-0 border-t border-r rounded-bl-none opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>
                  <div class="corner-marker bottom-0 left-0 border-b border-l rounded-tr-none opacity-0 group-hover:opacity-100 transition-opacity duration-200"></div>

                  <div class="aspect-video bg-gray-100 dark:bg-gray-800 relative overflow-hidden border-b border-gray-100 dark:border-gray-800 p-2">
                    <div class="absolute inset-0 bg-gray-100 dark:bg-gray-800"></div>
                    <div class="absolute inset-2 flex items-center justify-center text-gray-400">
                      {app.imageSrc ? (
                        <Image
                          src={app.imageSrc as any}
                          alt={app.name}
                          class="w-full h-full object-cover transition-transform duration-500 rounded-sm"
                          width={800}
                          height={450}
                          quality={90}
                          loading="lazy"
                          decoding="async"
                        />
                      ) : (
                        <div class="flex flex-col items-center justify-center">
                          <Icon name="lucide:image-off" class="w-8 h-8 text-gray-300" />
                        </div>
                      )}
                    </div>
                  </div>

                  <div class="p-5 flex-1 flex flex-col">
                    <div class="flex items-start justify-between gap-3 mb-2">
                      <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                          <h3 class="text-lg font-semibold text-gray-900 dark:text-white truncate m-0">{app.name}</h3>
                          {app.subtitle && (
                            <span class="inline-flex items-center justify-center px-2 py-0.5 text-xs font-medium text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/30 border border-blue-100 dark:border-blue-800 rounded-sm shrink-0 whitespace-nowrap">
                              {app.subtitle.replace(/[\[\]]/g, '')}
                            </span>
                          )}
                        </div>
                        <div class="flex flex-wrap gap-1 mb-2">
                          {app.features?.slice(0, 3).map((feature) => (
                            <span class="type-small text-gray-500 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 border border-gray-100 dark:border-gray-700 px-1.5 py-0.5">
                              {feature}
                            </span>
                          ))}
                        </div>
                      </div>
                    </div>

                    <p class="type-body text-gray-500 dark:text-gray-400 line-clamp-2 mb-4 flex-1 font-light">
                      {app.description}
                    </p>

                    <div class="space-y-4">
                      <div class="flex items-center gap-2 flex-wrap">
                        <span class="text-xs text-gray-400 line-through">¥{app.originalPrice.toFixed(2)}</span>
                        <span class="px-2.5 py-0.5 bg-gray-900 dark:bg-black text-[#FFD700] text-sm font-medium border border-gray-800 flex items-center gap-1 rounded-none">
                           <span class="text-[10px] font-normal text-gray-400">折后</span>
                           ¥{app.price.toFixed(2)}
                        </span>
                        {app.originalPrice > app.price && (
                          <span class="text-xs text-red-500 font-medium ml-auto">
                            省¥{Math.round(app.originalPrice - app.price)}
                          </span>
                        )}
                      </div>

                      <div class="flex items-center justify-between text-xs text-gray-400 pt-3 border-t border-gray-100 dark:border-gray-800">
                        <div class="flex items-center gap-2">
                          <div class="flex items-center gap-1">
                            <Icon name="lucide:badge-check" class="w-3.5 h-3.5" />
                            <span>官方认证</span>
                          </div>
                          {typeof app.rating === 'number' && (
                            <div class="flex items-center gap-1">
                              <Icon name="lucide:star" class="w-3.5 h-3.5 text-yellow-500 fill-current" />
                              <span>{app.rating}</span>
                            </div>
                          )}
                        </div>
                        <span>已售 {app.sales}</span>
                      </div>

                      <div class="flex gap-2 pt-3">
                        {app.buyLink && (
                          <a
                            href={app.buyLink}
                            target="_blank"
                            class="flex-1 inline-flex items-center justify-center h-9 px-2 text-xs font-medium text-blue-600 border border-blue-200 dark:border-blue-900 hover:border-blue-600 dark:hover:border-blue-500 bg-blue-50/50 dark:bg-blue-900/10 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-colors rounded-none"
                          >
                            <Icon name="lucide:shopping-cart" class="h-3.5 w-3.5 mr-1.5" />
                            购买
                          </a>
                        )}
                        {app.link && (
                          <a
                            href={app.link}
                            target="_blank"
                            class="flex-1 inline-flex items-center justify-center h-9 px-2 text-xs font-medium text-white bg-blue-600 hover:bg-blue-700 transition-colors rounded-none"
                          >
                            <Icon name="lucide:play" class="h-3.5 w-3.5 mr-1.5" />
                            演示
                          </a>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            ))}
          </div>

          <!-- 空状态 -->
          <div
            x-show="visibleCount === 0"
            class="flex flex-col items-center justify-center py-20 text-center"
            style="display: none;"
          >
            <div class="w-24 h-24 bg-gray-100 dark:bg-gray-800 rounded-full flex items-center justify-center mb-6 border border-gray-200 dark:border-gray-700">
              <Icon name="lucide:inbox" class="w-10 h-10 text-gray-400" />
            </div>
            <h3 class="type-heading font-medium text-gray-900 dark:text-white mb-2">未找到相关应用</h3>
            <p class="type-body text-gray-500 max-w-xs mx-auto">
              试试更换搜索关键词，或者切换分类看看吧
            </p>
            <button
              @click="searchQuery = ''; activeCategory = 'all'"
              class="mt-6 inline-flex items-center justify-center px-4 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm font-medium rounded-none text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none transition-colors"
            >
              重置筛选条件
            </button>
          </div>
        </main>
      </div>
    </div>
  </div>

  <Calltoaction />
  <Contact />
  <Footer />
</Layout>
