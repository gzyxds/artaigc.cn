---
/**
 * Header组件 - Bento Grid / Linear 风格优化版本
 * 网站的顶部导航栏组件，提供网站的主要导航功能
 * 优化内容：减少代码冗余，提升性能，简化数据结构，统一 Linear 设计风格，增强可访问性
 */

import astroLogo from '../../assets/logo.svg';
import { menuData, type MenuItem } from '../../data/menu';
import { Icon } from 'astro-icon/components';

/**
 * 获取logo的URL - 处理Astro的SVG导入类型
 */
const logoUrl = typeof astroLogo === 'string' ? astroLogo : astroLogo.src;
---

<!-- 主导航栏 - PC端隐藏，移动端显示 -->
<header id="site-header" class="lg:hidden sticky top-0 z-50 bg-background/90 backdrop-blur-md border-b border-border transition-colors duration-300">
  <div class="container-custom">
    <div class="flex items-center h-16">
      <!-- Logo区域 -->
      <div class="flex items-center">
        <a href="/" class="flex items-center space-x-2 group" aria-label="艺创AI 首页">
          <div class="p-1 border border-transparent group-hover:border-brand-500/20 transition-colors duration-300">
            <img src={logoUrl} alt="" class="h-10 w-10" aria-hidden="true" />
          </div>
          <span class="text-lg font-bold text-neutral-900 dark:text-white tracking-tight">艺创AI</span>
        </a>
      </div>

      <!-- 桌面端导航菜单 -->
      <nav class="hidden lg:flex items-center space-x-1 ml-8 xl:ml-12" aria-label="桌面端主导航">
        <a href="/" class="nav-link">首页</a>

        <!-- 企业级简约下拉菜单组件 -->
        {Object.entries(menuData).map(([key, items]) => {
          const menuName = key === 'products' ? '产品中心' :
                          key === 'solutions' ? '应用方案' :
                          key === 'docs' ? '产品文档' : '支持与服务';
          return (
            <div class="relative group">
              <button class="nav-link flex items-center whitespace-nowrap group/btn" aria-haspopup="true" aria-expanded="false">
                <span class="group-hover/btn:text-brand-600 dark:group-hover/btn:text-brand-400 transition-colors duration-200">
                  {menuName}
                </span>
                <span class="ml-1 transition-all duration-300 group-hover:rotate-180 text-neutral-400 group-hover/btn:text-brand-500">
                  <Icon name="lucide:chevron-down" class="h-3 w-3" />
                </span>
              </button>

              <!-- 企业级简约下拉容器 -->
              <div class="absolute left-0 top-full mt-2 w-[520px] bg-surface/95 backdrop-blur-md border border-border/50 rounded-sm opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 translate-y-2 group-hover:translate-y-0 shadow-xl shadow-black/5 dark:shadow-black/20 overflow-hidden">
                <div class="absolute top-0 right-0 w-20 h-20 bg-gradient-to-bl from-brand-50/50 to-transparent pointer-events-none"></div>

                <!-- 菜单标题区域 -->
                <div class="px-5 py-3 border-b border-border/50 flex justify-between items-center bg-neutral-50/30 dark:bg-neutral-800/30">
                  <h3 class="text-xs font-semibold text-neutral-500 dark:text-neutral-400 uppercase tracking-wider">
                    {menuName}
                  </h3>
                  <span class="text-[10px] text-neutral-400 font-mono">CMD + K</span>
                </div>

                <!-- 菜单项网格 -->
                <div class="p-3">
                  <div class="grid grid-cols-2 gap-2">
                    {items.map((item) => (
                      <a href={item.url} target={(item as MenuItem).target || undefined} class="group/item block rounded-sm relative overflow-hidden">
                        <div class="flex items-start space-x-3 p-3 hover:bg-neutral-100/80 dark:hover:bg-neutral-800/80 transition-colors duration-200 border border-transparent hover:border-border/50 rounded-sm">

                          <!-- 简约图标区域 -->
                          <div class="flex-shrink-0 mt-0.5">
                            <div class="w-8 h-8 rounded-sm bg-background border border-border flex items-center justify-center group-hover/item:border-brand-500/30 group-hover/item:bg-brand-50/10 transition-all duration-200">
                              <span class="w-4 h-4 text-neutral-500 dark:text-neutral-400 group-hover/item:text-brand-600 dark:group-hover/item:text-brand-400 transition-colors duration-200">
                                <Icon name={item.icon} class="w-4 h-4" />
                              </span>
                            </div>
                          </div>

                          <!-- 文本内容区域 -->
                          <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between">
                                <div class="text-sm font-medium text-neutral-900 dark:text-neutral-100 group-hover/item:text-brand-600 dark:group-hover/item:text-brand-400 transition-colors duration-200">
                                {item.name}
                                </div>
                                <span class="opacity-0 group-hover/item:opacity-100 transition-opacity duration-200 -translate-x-2 group-hover/item:translate-x-0" aria-hidden="true">
                                    <Icon name="lucide:arrow-right" class="w-3 h-3 text-brand-500" />
                                </span>
                            </div>
                            <div class="text-xs text-neutral-500 dark:text-neutral-400 mt-1 leading-relaxed line-clamp-2 font-normal">
                              {item.desc}
                            </div>
                          </div>
                        </div>
                      </a>
                    ))}
                  </div>
                </div>
               </div>
            </div>
          );
        })}

        <a href="/pricing" class="nav-link">产品价格</a>
        <a href="/company" class="nav-link">关于我们</a>
        <a href="/contact" class="nav-link">联系我们</a>
        <a href="/blog" class="nav-link">最新动态</a>
      </nav>

      <!-- 右侧操作区域 -->
      <div class="flex items-center space-x-0 ml-auto border-l border-border pl-4">
        <!-- 暗黑模式切换按钮 -->
        <button
          x-on:click="darkMode = !darkMode"
          class="p-2.5 rounded-none text-neutral-500 hover:text-brand-600 dark:text-neutral-400 dark:hover:text-brand-400 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors duration-200"
          aria-label="切换暗黑模式"
          :aria-pressed="darkMode"
        >
          <div x-show="!darkMode">
            <Icon name="lucide:moon" class="h-5 w-5" />
          </div>
          <div x-show="darkMode">
            <Icon name="lucide:sun" class="h-5 w-5" />
          </div>
        </button>

        <!-- 用户操作按钮 -->
        <div class="hidden md:flex items-center space-x-0 ml-2">
           <a
            href="https://console.cloudcvm.com/cart/goodsList.htm?fpg_id=61&spg_id=20"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-5 py-2.5 bg-background text-neutral-700 dark:text-neutral-200 text-sm font-medium border border-border hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-all border-r-0"
          >
            <span>登录</span>
          </a>
          <a
            href="https://console.cloudcvm.com/cart/goodsList.htm?fpg_id=61&spg_id=20"
            target="_blank"
            rel="noopener noreferrer"
            class="inline-flex items-center px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium transition-all border border-brand-600 hover:border-brand-700"
          >
            <span>立即购买</span>
          </a>
        </div>

        <!-- 移动端菜单按钮 -->
        <button
          x-data="{open: false}"
          x-on:click="open = !open; $dispatch('toggle-mobile-menu', {open})"
          class="lg:hidden p-2.5 rounded-none hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-colors duration-200 ml-2 border border-border"
          aria-label="切换菜单"
          :aria-expanded="open"
          aria-controls="mobile-menu"
        >
          <div x-bind:class="{'hidden': open, 'block': !open}">
            <Icon name="lucide:menu" class="h-6 w-6 text-neutral-600 dark:text-neutral-400" />
          </div>
          <div x-bind:class="{'block': open, 'hidden': !open}">
            <Icon name="lucide:x" class="h-6 w-6 text-neutral-600 dark:text-neutral-400" />
          </div>
        </button>
      </div>
    </div>
  </div>

  <!-- 优化的移动端菜单 -->
  <div
    id="mobile-menu"
    x-data="{ open: false }"
    x-on:toggle-mobile-menu.window="open = $event.detail.open"
    x-show="open"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0 -translate-y-4"
    x-transition:enter-end="opacity-100 translate-y-0"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100 translate-y-0"
    x-transition:leave-end="opacity-0 -translate-y-4"
    class="lg:hidden fixed inset-x-0 top-16 z-50 w-full overflow-hidden bg-background border-b border-border shadow-xl"
    x-cloak
  >
    <nav class="relative max-h-[calc(100vh-4rem)] overflow-y-auto p-0" aria-label="移动端导航">
      <div class="space-y-0 divide-y divide-border">
        <a href="/" class="mobile-nav-item">首页</a>

        <!-- 移动端菜单项 -->
        {Object.entries(menuData).map(([key, items]) => {
          const menuName = key === 'products' ? '产品中心' :
                          key === 'solutions' ? '应用方案' :
                          key === 'docs' ? '产品文档' : '支持与服务';
          return (
            <div x-data="{expanded: false}" class="rounded-none bg-background">
              <button
                x-on:click="expanded = !expanded"
                class="w-full flex items-center justify-between px-6 py-4 text-left hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-all duration-200 group rounded-none"
                :aria-expanded="expanded"
              >
                <span class="font-medium text-sm text-neutral-900 dark:text-white" x-bind:class="{'text-brand-600 dark:text-brand-400': expanded}">{menuName}</span>
                <span
                  x-bind:class="{'rotate-180 text-brand-600 dark:text-brand-400': expanded}"
                  class="transition-all duration-200 text-neutral-400 group-hover:text-brand-600 dark:group-hover:text-brand-400"
                >
                  <Icon name="lucide:chevron-down" class="h-4 w-4" />
                </span>
              </button>

              <div x-show="expanded" x-collapse x-cloak>
                <div class="bg-neutral-50 dark:bg-neutral-900/50 border-t border-border">
                  <div class="p-2">
                    <div class="grid grid-cols-2 gap-2">
                      {items.map(item => (
                        <a href={item.url} target={(item as MenuItem).target || undefined} class="group flex flex-col p-2.5 rounded-sm bg-background border border-border/50 hover:border-brand-500/30 hover:bg-neutral-50/50 dark:hover:bg-neutral-800/50 transition-all duration-200">
                          <div class="flex items-center gap-2 mb-1">
                            <div class="flex-shrink-0 flex items-center justify-center">
                              <span class="w-4 h-4 text-neutral-500 dark:text-neutral-400 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors duration-200">
                                <Icon name={item.icon} class="w-4 h-4" />
                              </span>
                            </div>
                            <div class="text-xs font-bold text-neutral-800 dark:text-neutral-200 group-hover:text-brand-600 dark:group-hover:text-brand-400 transition-colors duration-200 line-clamp-1">{item.name}</div>
                          </div>
                          <div class="text-[10px] leading-relaxed text-neutral-500 dark:text-neutral-400 line-clamp-2 font-normal mt-1">
                            {item.desc}
                          </div>
                        </a>
                      ))}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        })}

        <a href="/pricing" class="mobile-nav-item">产品价格</a>
        <a href="/company" class="mobile-nav-item">关于我们</a>
        <a href="/contact" class="mobile-nav-item">联系我们</a>
        <a href="/blog" class="mobile-nav-item">最新动态</a>
      </div>

      <!-- 移动端用户操作 -->
      <div class="p-6 border-t border-border">
        <div class="grid grid-cols-2 gap-4">
          <a
            href="https://console.cloudcvm.com/cart/goodsList.htm?fpg_id=61&spg_id=20"
            class="flex items-center justify-center px-4 py-3 border border-border hover:bg-neutral-50 dark:hover:bg-neutral-800 text-neutral-700 dark:text-neutral-300 text-sm font-medium transition-colors duration-200 rounded-none"
          >
            登录
          </a>
          <a
            href="https://auth.cnai.art/regist.htm"
            class="flex items-center justify-center px-4 py-3 bg-brand-600 hover:bg-brand-700 text-white text-sm font-medium transition-colors duration-200 rounded-none"
          >
            立即购买
          </a>
        </div>
      </div>
    </nav>
  </div>
</header>

<style>
  .nav-link {
    @apply px-4 py-2 text-[15px] font-medium text-neutral-600 dark:text-neutral-300 hover:text-brand-600 dark:hover:text-brand-400 transition-colors duration-200 relative;
  }

  .mobile-nav-item {
    @apply flex items-center justify-between w-full px-6 py-4 rounded-none text-neutral-700 dark:text-neutral-300 hover:text-brand-600 dark:hover:text-brand-400 hover:bg-neutral-50 dark:hover:bg-neutral-800 transition-all duration-200 text-[15px] font-medium;
  }

  [x-cloak] {
    display: none !important;
  }
</style>

<script is:inline>
  // 优化的滚动处理 - 使用requestAnimationFrame和防抖
  let header, lastScrollY = 0, ticking = false;

  function handleScroll() {
    // 使用ID选择器提高性能
    if (!header) header = document.getElementById('site-header');
    if (!header) return;

    const currentScrollY = window.scrollY;

    if (!ticking) {
      requestAnimationFrame(() => {
        // Linear风格：滚动时添加底部边框，而不是阴影
        if (currentScrollY > 10) {
            header.classList.add('border-border');
            header.classList.remove('border-transparent');
        } else {
            // 保持边框
        }
        lastScrollY = currentScrollY;
        ticking = false;
      });
      ticking = true;
    }
  }

  // 使用passive监听器优化性能
  window.addEventListener('scroll', handleScroll, { passive: true });

  // 初始化
  document.addEventListener('DOMContentLoaded', () => {
    header = document.getElementById('site-header');
    handleScroll();
  });
</script>
