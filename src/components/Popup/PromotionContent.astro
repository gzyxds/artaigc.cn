---
/**
 * é™æ—¶ç‰¹æƒ æ´»åŠ¨å¼¹çª—å†…å®¹ç»„ä»¶
 *
 * åŠŸèƒ½ç‰¹æ€§:
 * - å±•ç¤ºé™æ—¶ç‰¹æƒ æ´»åŠ¨ä¿¡æ¯
 * - äº§å“ä¼˜åŠ¿è¯´æ˜
 * - ä¼˜æƒ è¯¦æƒ…å±•ç¤º
 * - ä¼˜æƒ ç å¤åˆ¶åŠŸèƒ½
 * - å“åº”å¼è®¾è®¡
 * - æš—é»‘æ¨¡å¼æ”¯æŒ
 * - è‡ªåŠ¨å…³é—­åŠŸèƒ½
 * - è·Ÿéšæ»šåŠ¨
 *
 * @component PromotionContent
 * @author AI Assistant
 * @version 2.0.0
 */

import Popup from './Popup.astro';

export interface Props {
  /** æ˜¯å¦æ˜¾ç¤ºå¤åˆ¶æŒ‰é’® */
  showCopyButton?: boolean;
  /** è‡ªå®šä¹‰æ ·å¼ç±»å */
  className?: string;
  /** æ˜¯å¦è‡ªåŠ¨æ˜¾ç¤º */
  showOnLoad?: boolean;
  /** è‡ªåŠ¨å…³é—­æ—¶é—´(æ¯«ç§’) */
  autoCloseTime?: number;
}

const {
  showCopyButton = true,
  className = '',
  showOnLoad = true,
  autoCloseTime = 20000
} = Astro.props;

// å¼¹çª—é…ç½®
const popupConfig = {
  title: "é™æ—¶ç‰¹æƒ å…¬å‘Š",
  theme: "light" as const,
  autoClose: true,
  autoCloseTime: autoCloseTime,
  position: "center" as const,
  width: "min(90vw, 800px)",
  showOnLoad: showOnLoad,
  followScroll: true,
  showButtons: true,
  primaryButtonText: "ç«‹å³è´­ä¹°",
  secondaryButtonText: "è”ç³»å®¢æœ",
  primaryButtonUrl: "https://console.cloudcvm.com/cart/goodsList.htm?fpg_id=61&spg_id=20",
  secondaryButtonUrl: "/kefu"
};

// äº§å“æ•°æ®
const products = [
  {
    id: 1,
    name: 'æ•°å­—åˆ†èº«',
    originalPrice: 6800,
    salePrice: 4999,
    couponCode: 'oXu3x1IZD',
    colorClass: 'digital-human'
  },
  {
    id: 2,
    name: 'ä¼ä¸šçŸ¥è¯†åº“',
    originalPrice: 9800,
    salePrice: 6600,
    couponCode: 'Ju9han9Z6',
    colorClass: 'knowledge-base'
  },
  {
    id: 3,
    name: 'èŠå¤©ç»˜ç”»',
    originalPrice: 3800,
    salePrice: 2999,
    couponCode: '4ZKgZfv9M',
    colorClass: 'chat-drawing'
  },
  {
    id: 4,
    name: 'è®ºæ–‡å†™ä½œ',
    originalPrice: 4698,
    salePrice: 3200,
    couponCode: 'lbCG2L0Fq',
    colorClass: 'paper-writing'
  }
];
---

<Popup
  title={popupConfig.title}
  theme={popupConfig.theme}
  autoClose={popupConfig.autoClose}
  autoCloseTime={popupConfig.autoCloseTime}
  position={popupConfig.position}
  width={popupConfig.width}
  showOnLoad={popupConfig.showOnLoad}
  followScroll={popupConfig.followScroll}
  showButtons={popupConfig.showButtons}
  primaryButtonText={popupConfig.primaryButtonText}
  secondaryButtonText={popupConfig.secondaryButtonText}
  primaryButtonUrl={popupConfig.primaryButtonUrl}
  secondaryButtonUrl={popupConfig.secondaryButtonUrl}
>
  <div class={`promotion-content ${className}`}>
    <!-- äº§å“åˆ—è¡¨ -->
    <div class="products-section">
      <table class="products-table">
        <thead>
          <tr>
            <th>åºå·</th>
            <th>äº§å“åç§°</th>
            <th>åŸä»·</th>
            <th>ç‰¹æƒ ä»·</th>
            <th>ä¼˜æƒ ç </th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody>
          {products.map((product, index) => (
            <tr class="product-row">
              <td class="product-number">ğŸ“Œ {index + 1}</td>
              <td class="product-name">{product.name}</td>
              <td class="original-price">Â¥{product.originalPrice}</td>
              <td class="sale-price">Â¥{product.salePrice}</td>
              <td class="coupon-code">{product.couponCode}</td>
              <td class="action-cell">
                <button
                  class="copy-btn"
                  data-code={product.couponCode}
                  title="ç‚¹å‡»å¤åˆ¶ä¼˜æƒ ç "
                >
                  å¤åˆ¶
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- åé¢é™åˆ¶ -->
    <div class="limit-section">
      <span class="limit-text">ğŸ“Œ åé¢é™åˆ¶: æ¯ä¸ªä¼˜æƒ ç ä»…é™10ä¸ªï¼ŒæŠ¢å®Œå³æ­¢ï¼</span>
    </div>
  </div>
</Popup>

<style>
  /* å¼¹çª—å†…å®¹æ ·å¼ */
  .promotion-content {
    padding: clamp(20px, 5vw, 28px);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #fff;
  }

  /* äº§å“åˆ—è¡¨æ ·å¼ */
  .products-section {
    margin-bottom: clamp(20px, 5vw, 24px);
    overflow-x: auto;
  }

  .products-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: clamp(6px, 1.5vw, 8px);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .products-table th {
    background: #007bff;
    color: white;
    padding: clamp(10px, 2.5vw, 12px);
    text-align: center;
    font-weight: 600;
    font-size: clamp(13px, 3vw, 14px);
  }

  .products-table td {
    padding: clamp(8px, 2vw, 10px);
    text-align: center;
    border-bottom: 1px solid #e9ecef;
    font-size: clamp(12px, 2.8vw, 13px);
  }

  .product-row:nth-child(even) {
    background: #f8f9fa;
  }

  .product-row:hover {
    background: #e3f2fd;
  }

  .product-number {
    font-weight: 600;
    color: #007bff;
  }

  .product-name {
    font-weight: 700;
    color: #2c3e50;
  }

  .original-price {
    color: #6c757d;
    text-decoration: line-through;
  }

  .sale-price {
    font-weight: 700;
    color: #dc3545;
  }

  .coupon-code {
    font-family: 'Courier New', monospace;
    background: #fff3cd;
    color: #856404;
    padding: clamp(4px, 1vw, 6px) clamp(6px, 1.5vw, 8px);
    border-radius: clamp(3px, 0.8vw, 4px);
    border: 1px solid #ffeaa7;
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: clamp(11px, 2.5vw, 12px);
  }

  .copy-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: clamp(4px, 1vw, 6px) clamp(10px, 2.5vw, 12px);
    border-radius: clamp(4px, 1vw, 6px);
    font-size: clamp(12px, 3vw, 13px);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .copy-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
  }

  .copy-btn:active {
    transform: translateY(0);
  }

  .copy-btn.copied {
    background: #28a745;
  }

  /* åé¢é™åˆ¶æ ·å¼ */
  .limit-section {
    text-align: center;
    margin-bottom: clamp(4px, 1vw, 6px);
    padding: clamp(12px, 3vw, 16px);
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: clamp(6px, 1.5vw, 8px);
  }

  .limit-text {
    font-size: clamp(13px, 3.2vw, 14px);
    color: #856404;
    font-weight: 600;
  }

  /* å“åº”å¼è®¾è®¡ */
  @media (max-width: 768px) {
    .products-table {
      font-size: 12px;
    }

    .products-table th,
    .products-table td {
      padding: 6px 4px;
    }

    .coupon-code {
      font-size: 10px;
      padding: 2px 4px;
    }

    .copy-btn {
      padding: 4px 8px;
      font-size: 10px;
    }
  }

</style>

<script>
  /**
   * åˆå§‹åŒ–å¤åˆ¶åŠŸèƒ½
   */
  function initCopyButtons() {
    const copyButtons = document.querySelectorAll('.copy-btn');

    copyButtons.forEach(button => {
      const htmlButton = button as HTMLElement;
      htmlButton.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const code = htmlButton.getAttribute('data-code');
        if (!code) {
          console.warn('å¤åˆ¶æŒ‰é’®ç¼ºå°‘ä¼˜æƒ ç æ•°æ®');
          return;
        }

        try {
          // å°è¯•ä½¿ç”¨ç°ä»£ Clipboard API
          await navigator.clipboard.writeText(code);
          showCopySuccess(htmlButton);
        } catch (err) {
          console.warn('Clipboard API å¤±è´¥ï¼Œå°è¯•é™çº§æ–¹æ¡ˆ:', err);

          // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
          try {
            const textArea = document.createElement('textarea');
            textArea.value = code;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
              showCopySuccess(htmlButton);
            } else {
              throw new Error('execCommand å¤åˆ¶å¤±è´¥');
            }
          } catch (fallbackErr) {
            console.error('æ‰€æœ‰å¤åˆ¶æ–¹æ³•éƒ½å¤±è´¥äº†:', fallbackErr);
            showCopyError(htmlButton);
          }
        }
      });
    });
  }

  /**
   * æ˜¾ç¤ºå¤åˆ¶æˆåŠŸçŠ¶æ€
   * @param {HTMLElement} button - å¤åˆ¶æŒ‰é’®å…ƒç´ 
   */
  function showCopySuccess(button: HTMLElement) {
    const copyText = button.querySelector('.copy-text') as HTMLElement;
    const copySuccess = button.querySelector('.copy-success') as HTMLElement;

    if (copyText && copySuccess) {
      copyText.style.display = 'none';
      copySuccess.style.display = 'inline';
    } else {
      button.textContent = 'å·²å¤åˆ¶';
    }

    button.classList.add('copied');
    (button as any).disabled = true;

    // 2ç§’åæ¢å¤åŸçŠ¶
    setTimeout(() => {
      if (copyText && copySuccess) {
        copyText.style.display = 'inline';
        copySuccess.style.display = 'none';
      } else {
        button.textContent = 'å¤åˆ¶';
      }

      button.classList.remove('copied');
      (button as any).disabled = false;
    }, 2000);
  }

  /**
   * æ˜¾ç¤ºå¤åˆ¶é”™è¯¯çŠ¶æ€
   * @param {HTMLElement} button - å¤åˆ¶æŒ‰é’®å…ƒç´ 
   */
  function showCopyError(button: HTMLElement) {
    const originalText = button.textContent;
    button.textContent = 'å¤åˆ¶å¤±è´¥';
    button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';

    setTimeout(() => {
      button.textContent = originalText;
      button.style.background = '';
    }, 2000);
  }

  /**
   * é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
   */
  function initPromotion() {
    try {
      initCopyButtons();
      console.log('ä¿ƒé”€å¼¹çª—åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('ä¿ƒé”€å¼¹çª—åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }

  // ç¡®ä¿åœ¨ DOM åŠ è½½å®Œæˆåæ‰§è¡Œ
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPromotion);
  } else {
    initPromotion();
  }

  // æ”¯æŒåŠ¨æ€åŠ è½½çš„æƒ…å†µ
  if (typeof window !== 'undefined') {
    (window as any).initPromotion = initPromotion;
  }
</script>
