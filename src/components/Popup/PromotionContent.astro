---
/**
 * 限时特惠活动弹窗内容组件
 *
 * 功能特性:
 * - 展示限时特惠活动信息
 * - 产品优势说明
 * - 优惠详情展示
 * - 优惠码复制功能
 * - 响应式设计
 * - 暗黑模式支持
 * - 自动关闭功能
 * - 跟随滚动
 *
 * @component PromotionContent
 * @author AI Assistant
 * @version 2.0.0
 */

import Popup from './Popup.astro';

export interface Props {
  /** 是否显示复制按钮 */
  showCopyButton?: boolean;
  /** 自定义样式类名 */
  className?: string;
  /** 是否自动显示 */
  showOnLoad?: boolean;
  /** 自动关闭时间(毫秒) */
  autoCloseTime?: number;
}

const {
  showCopyButton = true,
  className = '',
  showOnLoad = true,
  autoCloseTime = 20000
} = Astro.props;

// 弹窗配置
const popupConfig = {
  title: "限时特惠公告",
  theme: "light" as const,
  autoClose: true,
  autoCloseTime: autoCloseTime,
  position: "center" as const,
  width: "min(90vw, 800px)",
  showOnLoad: showOnLoad,
  followScroll: true,
  showButtons: true,
  primaryButtonText: "立即购买",
  secondaryButtonText: "联系客服",
  primaryButtonUrl: "https://console.cloudcvm.com/cart/goodsList.htm?fpg_id=61&spg_id=20",
  secondaryButtonUrl: "/kefu"
};

// 产品数据
const products = [
  {
    id: 1,
    name: '数字分身',
    originalPrice: 6800,
    salePrice: 4999,
    couponCode: 'oXu3x1IZD',
    colorClass: 'digital-human'
  },
  {
    id: 2,
    name: '企业知识库',
    originalPrice: 9800,
    salePrice: 6600,
    couponCode: 'Ju9han9Z6',
    colorClass: 'knowledge-base'
  },
  {
    id: 3,
    name: '聊天绘画',
    originalPrice: 3800,
    salePrice: 2999,
    couponCode: '4ZKgZfv9M',
    colorClass: 'chat-drawing'
  },
  {
    id: 4,
    name: '论文写作',
    originalPrice: 4698,
    salePrice: 3200,
    couponCode: 'lbCG2L0Fq',
    colorClass: 'paper-writing'
  }
];
---

<Popup
  title={popupConfig.title}
  theme={popupConfig.theme}
  autoClose={popupConfig.autoClose}
  autoCloseTime={popupConfig.autoCloseTime}
  position={popupConfig.position}
  width={popupConfig.width}
  showOnLoad={popupConfig.showOnLoad}
  followScroll={popupConfig.followScroll}
  showButtons={popupConfig.showButtons}
  primaryButtonText={popupConfig.primaryButtonText}
  secondaryButtonText={popupConfig.secondaryButtonText}
  primaryButtonUrl={popupConfig.primaryButtonUrl}
  secondaryButtonUrl={popupConfig.secondaryButtonUrl}
>
  <div class={`promotion-content ${className}`}>
    <!-- 产品列表 -->
    <div class="products-section">
      <table class="products-table">
        <thead>
          <tr>
            <th>序号</th>
            <th>产品名称</th>
            <th>原价</th>
            <th>特惠价</th>
            <th>优惠码</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody>
          {products.map((product, index) => (
            <tr class="product-row">
              <td class="product-number">📌 {index + 1}</td>
              <td class="product-name">{product.name}</td>
              <td class="original-price">¥{product.originalPrice}</td>
              <td class="sale-price">¥{product.salePrice}</td>
              <td class="coupon-code">{product.couponCode}</td>
              <td class="action-cell">
                <button
                  class="copy-btn"
                  data-code={product.couponCode}
                  title="点击复制优惠码"
                >
                  复制
                </button>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <!-- 名额限制 -->
    <div class="limit-section">
      <span class="limit-text">📌 名额限制: 每个优惠码仅限10个，抢完即止！</span>
    </div>
  </div>
</Popup>

<style>
  /* 弹窗内容样式 */
  .promotion-content {
    padding: clamp(20px, 5vw, 28px);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    line-height: 1.6;
    color: #333;
    background: #fff;
  }

  /* 产品列表样式 */
  .products-section {
    margin-bottom: clamp(20px, 5vw, 24px);
    overflow-x: auto;
  }

  .products-table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    border-radius: clamp(6px, 1.5vw, 8px);
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .products-table th {
    background: #007bff;
    color: white;
    padding: clamp(10px, 2.5vw, 12px);
    text-align: center;
    font-weight: 600;
    font-size: clamp(13px, 3vw, 14px);
  }

  .products-table td {
    padding: clamp(8px, 2vw, 10px);
    text-align: center;
    border-bottom: 1px solid #e9ecef;
    font-size: clamp(12px, 2.8vw, 13px);
  }

  .product-row:nth-child(even) {
    background: #f8f9fa;
  }

  .product-row:hover {
    background: #e3f2fd;
  }

  .product-number {
    font-weight: 600;
    color: #007bff;
  }

  .product-name {
    font-weight: 700;
    color: #2c3e50;
  }

  .original-price {
    color: #6c757d;
    text-decoration: line-through;
  }

  .sale-price {
    font-weight: 700;
    color: #dc3545;
  }

  .coupon-code {
    font-family: 'Courier New', monospace;
    background: #fff3cd;
    color: #856404;
    padding: clamp(4px, 1vw, 6px) clamp(6px, 1.5vw, 8px);
    border-radius: clamp(3px, 0.8vw, 4px);
    border: 1px solid #ffeaa7;
    font-weight: 600;
    letter-spacing: 0.5px;
    font-size: clamp(11px, 2.5vw, 12px);
  }

  .copy-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: clamp(4px, 1vw, 6px) clamp(10px, 2.5vw, 12px);
    border-radius: clamp(4px, 1vw, 6px);
    font-size: clamp(12px, 3vw, 13px);
    cursor: pointer;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .copy-btn:hover {
    background: #0056b3;
    transform: translateY(-1px);
  }

  .copy-btn:active {
    transform: translateY(0);
  }

  .copy-btn.copied {
    background: #28a745;
  }

  /* 名额限制样式 */
  .limit-section {
    text-align: center;
    margin-bottom: clamp(4px, 1vw, 6px);
    padding: clamp(12px, 3vw, 16px);
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: clamp(6px, 1.5vw, 8px);
  }

  .limit-text {
    font-size: clamp(13px, 3.2vw, 14px);
    color: #856404;
    font-weight: 600;
  }

  /* 响应式设计 */
  @media (max-width: 768px) {
    .products-table {
      font-size: 12px;
    }

    .products-table th,
    .products-table td {
      padding: 6px 4px;
    }

    .coupon-code {
      font-size: 10px;
      padding: 2px 4px;
    }

    .copy-btn {
      padding: 4px 8px;
      font-size: 10px;
    }
  }

</style>

<script>
  /**
   * 初始化复制功能
   */
  function initCopyButtons() {
    const copyButtons = document.querySelectorAll('.copy-btn');

    copyButtons.forEach(button => {
      const htmlButton = button as HTMLElement;
      htmlButton.addEventListener('click', async (e) => {
        e.preventDefault();
        e.stopPropagation();

        const code = htmlButton.getAttribute('data-code');
        if (!code) {
          console.warn('复制按钮缺少优惠码数据');
          return;
        }

        try {
          // 尝试使用现代 Clipboard API
          await navigator.clipboard.writeText(code);
          showCopySuccess(htmlButton);
        } catch (err) {
          console.warn('Clipboard API 失败，尝试降级方案:', err);

          // 降级方案：使用传统方法
          try {
            const textArea = document.createElement('textarea');
            textArea.value = code;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            const successful = document.execCommand('copy');
            document.body.removeChild(textArea);

            if (successful) {
              showCopySuccess(htmlButton);
            } else {
              throw new Error('execCommand 复制失败');
            }
          } catch (fallbackErr) {
            console.error('所有复制方法都失败了:', fallbackErr);
            showCopyError(htmlButton);
          }
        }
      });
    });
  }

  /**
   * 显示复制成功状态
   * @param {HTMLElement} button - 复制按钮元素
   */
  function showCopySuccess(button: HTMLElement) {
    const copyText = button.querySelector('.copy-text') as HTMLElement;
    const copySuccess = button.querySelector('.copy-success') as HTMLElement;

    if (copyText && copySuccess) {
      copyText.style.display = 'none';
      copySuccess.style.display = 'inline';
    } else {
      button.textContent = '已复制';
    }

    button.classList.add('copied');
    (button as any).disabled = true;

    // 2秒后恢复原状
    setTimeout(() => {
      if (copyText && copySuccess) {
        copyText.style.display = 'inline';
        copySuccess.style.display = 'none';
      } else {
        button.textContent = '复制';
      }

      button.classList.remove('copied');
      (button as any).disabled = false;
    }, 2000);
  }

  /**
   * 显示复制错误状态
   * @param {HTMLElement} button - 复制按钮元素
   */
  function showCopyError(button: HTMLElement) {
    const originalText = button.textContent;
    button.textContent = '复制失败';
    button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';

    setTimeout(() => {
      button.textContent = originalText;
      button.style.background = '';
    }, 2000);
  }

  /**
   * 页面加载完成后初始化
   */
  function initPromotion() {
    try {
      initCopyButtons();
      console.log('促销弹窗初始化完成');
    } catch (error) {
      console.error('促销弹窗初始化失败:', error);
    }
  }

  // 确保在 DOM 加载完成后执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initPromotion);
  } else {
    initPromotion();
  }

  // 支持动态加载的情况
  if (typeof window !== 'undefined') {
    (window as any).initPromotion = initPromotion;
  }
</script>
