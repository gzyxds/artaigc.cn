---
/**
 * Layout组件
 * 这是网站的基础布局组件，提供所有页面的基本HTML结构
 * 包含以下功能：
 * 1. 提供基本的HTML、head和body标签
 * 2. 设置页面的元数据（标题、描述、关键词）
 * 3. 引入全局样式和过渡效果
 * 4. 支持暗黑模式切换
 * 5. 集成百度统计
 * 6. 提供悬浮按钮组（客服咨询、返回顶部）
 * 7. 集成二维码弹窗功能
 */
 import '../styles/global.css';
import '../styles/transitions.css';
import { ViewTransitions } from 'astro:transitions';
import FloatingButtons from '../components/FloatingButtons.astro';
import QRModal from '../components/QRModal.astro';
import MobileBottomConsult from '../components/MobileBottomConsult.astro';
import BackgroundGrid from '../components/BackgroundGrid.astro';

/**
 * 定义组件属性接口
 * 用于TypeScript类型检查，确保组件接收正确的属性
 * @property {string} title - 页面标题，用于SEO和浏览器标签
 * @property {string} [description] - 页面描述，用于SEO，可选
 * @property {string} [keywords] - 页面关键词，用于SEO，可选
 */
export interface Props {
  title: string;
  description?: string;
  keywords?: string;
}

/**
 * 解构组件属性，设置默认值
 * 从Astro.props中获取传入的属性，并为可选属性设置默认值
 * 这些属性将用于页面的元数据和SEO优化
 */
const {
  title,
  description = "专注提供AI系统源代码解决方案的技术团队「超级全能AI变现系统」「AI聊天绘画系统」「AI论文写作系统」拥有PHP和Java两种语言版本，技术实力强，系统体验好支持私有部署，专业团队、售后无忧",
  keywords = "AI系统,AI源码,AI变现系统,AI聊天系统,AI绘画系统,AI论文系统,PHP AI系统,Java AI系统"
} = Astro.props;
---

<!doctype html>
<!-- 使用Alpine.js管理暗黑模式状态 -->
<html lang="zh-CN" 
  x-data="{ 
    darkMode: localStorage.getItem('darkMode') === 'true' || (!('darkMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)
  }" 
  x-init="$watch('darkMode', val => {
    localStorage.setItem('darkMode', val);
    if (val) document.documentElement.classList.add('dark');
    else document.documentElement.classList.remove('dark');
  })"
  :class="{ 'dark': darkMode }"
>
  <head>
    <script is:inline>
      // 防闪烁脚本：在页面加载前立即执行主题检测
      (function() {
        const getTheme = () => {
          if (typeof localStorage !== 'undefined' && localStorage.getItem('darkMode')) {
            return localStorage.getItem('darkMode') === 'true';
          }
          return window.matchMedia('(prefers-color-scheme: dark)').matches;
        };
        if (getTheme()) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.ico" />
    <meta name="generator" content={Astro.generator} />
    <meta name="description" content={description} />
    <meta name="keywords" content={keywords} />
    <title>{title}</title>
    <!-- 引入Material Icons -->
    <link rel="stylesheet" href="/fonts/material-icons/material-icons.css">
    <!-- 启用Astro页面过渡效果 -->
    <ViewTransitions />
  </head>
  <!-- 使用Tailwind设置基础样式和暗黑模式 -->
  <body class="antialiased bg-white dark:bg-neutral-950 text-neutral-900 dark:text-neutral-100 transition-colors duration-300 scroll-animation relative">
    <!-- 全局网格背景 -->
    <BackgroundGrid />

    <!-- 页面包装器，用于过渡动画 -->
    <div id="page-wrapper" class="page-transition-wrapper relative z-10 flex flex-col min-h-screen">
      <slot />
    </div>

    <!-- 悬浮按钮组：客服咨询和返回顶部 -->
    <FloatingButtons qrCodeUrl="/assets/qrcode.png" />

    <!-- 二维码弹窗模态框 -->
    <QRModal qrCodeUrl="/assets/qrcode.png" title="联系客服" description="扫描二维码添加客服微信，获取专业技术支持" />

    <!-- 手机端底部业务咨询组件 -->
    <MobileBottomConsult
      phoneNumber="400-123-4567"
      presalesQR="/assets/qrcode.png"
      aftersalesQR="/assets/qrcode.png"
    />
    <script>
      /**
       * 暗黑模式初始化
       * 检查用户偏好设置，如果没有则使用系统偏好
       */
      if (localStorage.getItem('darkMode') === null) {
        // 检查系统偏好
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
          localStorage.setItem('darkMode', 'true');
          document.documentElement.classList.add('dark');
        } else {
          localStorage.setItem('darkMode', 'false');
        }
      }

      /**
       * 滚动动画观察者
       * 当元素进入视口时添加 .scroll-animated 类
       */
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('scroll-animated');
            observer.unobserve(entry.target); // 动画只播放一次
          }
        });
      }, observerOptions);

      function initScrollAnimation() {
        const elements = document.querySelectorAll('.scroll-animate, .col:not(.no-scroll-animation)');
        elements.forEach(el => observer.observe(el));
      }

      /**
       * 页面过渡效果处理
       * 在页面加载完成后添加过渡类
       */
      document.addEventListener('astro:page-load', () => {
        // 这在初始页面加载和每次导航后运行
        const pageWrapper = document.getElementById('page-wrapper');
        if (pageWrapper) {
          pageWrapper.classList.add('page-loaded');
        }
        // 初始化滚动动画
        initScrollAnimation();
      });

      /**
       * 页面切换前处理
       * 在新页面内容被替换前移除过渡类
       */
      document.addEventListener('astro:before-swap', () => {
        // 这在新页面内容被替换之前运行
        const pageWrapper = document.getElementById('page-wrapper');
        if (pageWrapper) {
          pageWrapper.classList.remove('page-loaded');
        }
      });


    </script>
    <!-- 引入过渡动画脚本 -->
    <script src="../scripts/transitions.js"></script>
</body>
</html>
